<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>assistant commercial LesFacilitateurs </title>
<link rel="icon" href="https://i.ibb.co/4JH0qZt/african-head.png" type="image/png">
<style>
:root{
  --bg:#0b1220; --accent:#2563eb; --card:rgba(255,255,255,0.03); --text:#e6eef8;
}
body{margin:0;font-family:Inter,Arial,sans-serif;background:var(--bg);color:var(--text);}

/* BOT FLOAT */
#botFloat{
  position:fixed; left:20px; bottom:20px; width:72px; height:72px; border-radius:50%;
  background:var(--accent); display:flex; align-items:center; justify-content:center; cursor:pointer; z-index:1100;
}
#botFloat img{width:60%;height:60%;border-radius:50%;}

/* BOT BOX */
#botBox{
  position:fixed; left:50%; bottom:110px; transform:translateX(-50%);
  width:350px; max-height:80vh; background:var(--card); border-radius:12px;
  display:flex; flex-direction:column; overflow:hidden; z-index:1100; backdrop-filter:blur(6px); display:none;
}
#botHead{padding:10px;background:var(--accent);color:white;display:flex;align-items:center;gap:8px;}
#botHead .title{flex:1;font-weight:700;}
#botBody{flex:1;padding:12px;overflow:auto;display:flex;flex-direction:column;gap:8px;}
.msg{max-width:86%;padding:8px 10px;border-radius:10px;line-height:1.35;font-size:14px;}
.msg.bot{background:rgba(255,255,255,0.04);align-self:flex-start;color:var(--text);}
.msg.user{background:rgba(255,255,255,0.06);align-self:flex-end;color:#041025;}
#botFooter{display:flex;padding:8px;border-top:1px solid rgba(255,255,255,0.05);gap:6px;}
#botFooter input{flex:1;padding:8px;border-radius:8px;border:none;background:rgba(255,255,255,0.03);color:white;outline:none;}
#botFooter button{padding:6px 10px;border:none;border-radius:8px;background:var(--accent);color:white;cursor:pointer}

/* LISTE DES AUTORISATIONS */
#authList{
  display:none; position:fixed; top:70px; left:50%; transform:translateX(-50%);
  width:360px; max-height:240px; overflow:auto; background:#172544; padding:8px; border-radius:8px; z-index:1090;
}
.auth-item{padding:8px;border-radius:6px;margin-bottom:6px;background:rgba(255,255,255,0.02);cursor:pointer}
.auth-item:hover{background:rgba(255,255,255,0.04)}

/* ADMIN PANEL */
#adminPanel {
  position: fixed;
  top: 20px;           /* distance depuis le haut */
  right: 20px;         /* distance depuis la droite */
  width: 400px;        /* largeur du panel */
  max-height: 80vh;    /* hauteur max */
  overflow: auto;
  background: rgba(0,0,0,0.85);
  border-radius: 12px;
  padding: 16px;
  z-index: 1200;
  box-shadow: 0 20px 60px rgba(0,0,0,0.6);
  transform: none;     /* on supprime le translate pour ne pas le centrer */

}
#adminPanel h2, #adminPanel h3{color:white; margin:8px 0;}
#adminPanel .table{width:100%; border-collapse:collapse; margin-top:10px;}
#adminPanel .table th{background:var(--accent); color:white; padding:8px; text-align:left;}
#adminPanel .table td{padding:6px; border-bottom:1px solid rgba(255,255,255,0.04);}
#adminPanel .action-btn{background:transparent; border:1px solid rgba(255,255,255,0.06); color:white; padding:4px 6px; border-radius:6px; cursor:pointer;}

/* Responsive */
@media (max-width:420px){
  #botBox{width:calc(100% - 20px); left:10px; transform:none;}
  #authList{width:calc(100% - 20px);}
  #adminPanel{width:95%;}
}
</style>
</head>
<body>

<!-- BOT FLOAT -->
<div id="botFloat" title="Ouvrir le bot">
  <img src="https://i.ibb.co/4JH0qZt/african-head.png" alt="bot">
</div>

<!-- BOT BOX -->
<div id="botBox">
  <div id="botHead">
    <div class="title">ü§µüèø   LesFacilitateurs</div>
    <div id="userIdDisplay">ID: <span id="userId">12345</span></div>
    <button id="toggleAuthBtn" style="background:#1b2b4a;color:white;border:none;padding:6px;border-radius:6px;cursor:pointer">Autorisations</button>
    <div style="margin-left:8px;">
      <input id="adminInput" type="password" placeholder="Code admin" style="background:rgba(255,255,255,0.06);border:none;color:white;padding:6px;border-radius:6px;outline:none">
      <button id="adminBtn" style="background:rgba(255,255,255,0.06);border:none;padding:6px;border-radius:6px;color:white;cursor:pointer">‚û°</button>
    </div>
  </div>
  <div id="botBody" aria-live="polite">
    <div class="msg bot">Bonjour üëã ‚Äî je suis LesFacilitateurs. Clique sur Autorisations ou entre le code admin.</div>
  </div>
  <div id="botFooter">
    <input id="inputText" placeholder="√âcris ton message..." autocomplete="off">
    <button id="sendBtn">üì®</button>
  </div>
</div>

<!-- LISTE DES AUTORISATIONS -->
<div id="authList"></div>

<!-- ADMIN PANEL -->
<div id="adminPanel">
  <div style="display:flex; justify-content:space-between; align-items:center;">
    <h2>üîí Tableau administrateur</h2>
    <button id="closeAdminBtn" style="background:var(--accent); color:white; padding:6px; border-radius:6px; border:none; cursor:pointer">Fermer</button>
  </div>
  <h3>Instructions 
    <button id="addInstrBtn" style="margin-left:8px; padding:6px; border-radius:6px; border:none; cursor:pointer">+</button>
  </h3>
  <table class="table" id="instrTable">
    <thead><tr><th>ID</th><th>Instruction</th><th>Actions</th></tr></thead>
    <tbody></tbody>
  </table>
</div>
<!-- Ent√™te manuscrite fixe -->
<div class="handwritten-header">
  üìöassistant commercial Lesfacilitateurs Middleman What's 651475255üí∞
</div>

<style>
/* Police manuscrite via Google Fonts */
@import url('https://fonts.googleapis.com/css2?family=Indie+Flower&display=swap');

.handwritten-header {
  position: sticky; /* reste en haut quand tu scroll */
  top: 0;
  background-color: rgba(37,99,235,0.9); /* bleu accent */
  color: white;
  font-family: 'Indie Flower', cursive; /* √©criture √† la main */
  font-size: 24px;
  padding: 12px 16px;
  text-align: center;
  border-bottom: 2px solid rgba(255,255,255,0.3);
  z-index: 1000; /* au-dessus des autres √©l√©ments */
  box-shadow: 0 2px 8px rgba(0,0,0,0.3);
}
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script>
const supabaseUrl = 'https://ycotvgvevyfyqflicmtw.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inljb3R2Z3ZldnlmeXFmbGljbXR3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAxMTQxMzIsImV4cCI6MjA3NTY5MDEzMn0.Yyod-LWZVv5t5PggZ1EZm83vgkvHgaJd2QFJe4_vMDQ';
const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

const botFloat = document.getElementById('botFloat');
const botBox = document.getElementById('botBox');
const botBody = document.getElementById('botBody');
const inputText = document.getElementById('inputText');
const sendBtn = document.getElementById('sendBtn');
const toggleAuthBtn = document.getElementById('toggleAuthBtn');
const authListDiv = document.getElementById('authList');
const adminInput = document.getElementById('adminInput');
const adminBtn = document.getElementById('adminBtn');
const adminPanel = document.getElementById('adminPanel');
const closeAdminBtn = document.getElementById('closeAdminBtn');
const addInstrBtn = document.getElementById('addInstrBtn');
const instrTableBody = document.getElementById('instrTable').querySelector('tbody');

let instructions = [];

// Afficher message dans le bot
function appendMsg(sender, text) {
  const div = document.createElement('div');
  div.className = 'msg ' + sender;
  div.innerHTML = text;
  botBody.appendChild(div);
  botBody.scrollTop = botBody.scrollHeight;
}

// Charger instructions depuis Supabase
async function loadInstructions() {
  const { data, error } = await supabase.from('bot_instructions').select('*');
  if (!error && data) {
    instructions = data;
    renderInstrTable();
  }
}

// Afficher tableau des instructions
function renderInstrTable() {
  instrTableBody.innerHTML = '';
  instructions.forEach(i => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${i.id}</td>
      <td>${i.instruction}</td>
      <td>
        <button class="action-btn edit-btn" data-id="${i.id}">Modifier</button>
        <button class="action-btn delete-btn" data-id="${i.id}">Supprimer</button>
      </td>
    `;
    instrTableBody.appendChild(row);
  });

  // Ajouter les √©v√©nements apr√®s cr√©ation
  document.querySelectorAll('.edit-btn').forEach(btn => {
    btn.onclick = async () => {
      const id = btn.dataset.id;
      const instr = instructions.find(ins => ins.id == id);
      const newText = prompt('Modifier instruction:', instr.instruction);
      if (newText) {
        await supabase.from('bot_instructions').update({ instruction: newText }).eq('id', id);
        loadInstructions();
      }
    }
  });

  document.querySelectorAll('.delete-btn').forEach(btn => {
    btn.onclick = async () => {
      const id = btn.dataset.id;
      if (!confirm('Supprimer cette instruction ?')) return;
      await supabase.from('bot_instructions').delete().eq('id', id);
      loadInstructions();
    }
  });
}

// Modifier une instruction
window.editInstr = async function(id) {
  const instr = instructions.find(i => i.id === id);
  if (!instr) return;
  const t = prompt('Modifier instruction:', instr.instruction);
  if (t) {
    await supabase.from('bot_instructions').update({ instruction: t }).eq('id', id);
    loadInstructions();
  }
}

// Supprimer une instruction
window.deleteInstr = async function(id) {
  if (!confirm('Supprimer cette instruction ?')) return;
  await supabase.from('bot_instructions').delete().eq('id', id);
  loadInstructions();
}

// Ajouter une instruction
addInstrBtn.onclick = async function() {
  const t = prompt('Nouvelle instruction:');
  if (t) {
    await supabase.from('bot_instructions').insert([{ instruction: t }]);
    loadInstructions();
  }
}

// Ouvrir/fermer le bot
botFloat.onclick = () => {
  botBox.style.display = botBox.style.display === 'flex' ? 'none' : 'flex';
};

// Envoyer message utilisateur et r√©ponse intelligente
sendBtn.onclick = async () => {
  const text = inputText.value.trim().toLowerCase();
  if (!text) return;

  appendMsg('user', text);
  inputText.value = '';

  // Chercher correspondance dans instructions
  const match = instructions.find(i => i.instruction.toLowerCase().includes(text));
  if (match) {
    appendMsg('bot', match.instruction);
  } else {
    appendMsg('bot', "Je n'ai pas trouv√© de r√©ponse. Peux-tu reformuler ?");
  }
};

// Liste des autorisations
toggleAuthBtn.onclick = async () => {
  authListDiv.style.display = authListDiv.style.display === 'block' ? 'none' : 'block';
  authListDiv.innerHTML = '';

  const { data, error } = await supabase.from('users').select('id,user_authorization');
  if (error) {
    appendMsg('bot', 'Erreur lors du chargement des utilisateurs.');
    return;
  }

  data.forEach(u => {
    const div = document.createElement('div');
    div.className = 'auth-item';
    div.textContent = `${u.user_authorization} - ID: ${u.id}`;
    div.onclick = () => appendMsg('bot', 'Autorisation s√©lectionn√©e: ' + u.user_authorization);
    authListDiv.appendChild(div);
  });
};

// Login admin
adminBtn.onclick = () => {
  if (adminInput.value === '233233') {
    adminPanel.style.display = 'block';
    botBox.style.display = 'none';
    loadInstructions();
  } else {
    alert('Code incorrect');
  }
};

// Fermer le panel admin
closeAdminBtn.onclick = () => {
  adminPanel.style.display = 'none';
  botBox.style.display = 'flex';
};

// Charger initialement les instructions
loadInstructions();
</script>
</body>
</html>